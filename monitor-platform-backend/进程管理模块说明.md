# 进程管理模块使用说明

## 模块概述

进程管理模块是监控平台的核心功能之一，用于监控和管理各个服务器上运行的进程服务。该模块提供了完整的进程生命周期管理功能，包括进程监控、数据采集、图表展示、优雅的启停操作，以及线程监控和线程堆栈分析。

## 主要功能

### 1. 进程监控
- 实时显示所有服务器上的进程状态
- 按服务器、状态、类型筛选进程
- 展示进程基本信息：PID、类型、端口、用户等
- 统计摘要：总进程数、运行中、已停止、异常进程

### 2. 资源监控
- CPU使用率监控
- 内存使用量和内存使用率监控
- 线程数和句柄数监控
- 磁盘读写速率监控
- 网络收发速率监控
- 进程运行时间统计

### 3. 线程监控（新增）
- **线程列表查看**：查看进程中所有线程的实时状态
- **线程状态分析**：运行中、等待、限时等待、阻塞等状态统计
- **线程堆栈追踪**：查看线程当前执行的调用堆栈
- **性能指标**：CPU时间、等待时间、阻塞时间
- **状态筛选**：按线程状态快速定位问题线程
- **自动采集**：支持采集模拟线程数据

### 4. 进程管理
- **启动进程**：优雅启动，支持自定义启动命令
- **停止进程**：优雅停止，支持自定义停止命令或PID停止
- **重启进程**：自动执行停止后启动的流程
- **删除进程**：从监控列表中移除进程

### 5. 数据采集
- 支持手动触发资源数据采集
- 生成模拟资源数据用于测试
- 支持采集线程监控数据
- 自动记录历史资源数据
- 数据可视化图表展示

### 6. 进程详情
- 查看完整的进程信息
- 查看资源使用趋势图表
- 显示启动和停止命令
- 支持修改进程配置

## 线程监控功能详解

### 线程状态说明

- **RUNNABLE（运行中）**：线程正在运行或准备好运行，等待CPU时间
- **WAITING（等待）**：线程正在等待另一个线程执行操作
- **TIMED_WAITING（限时等待）**：线程正在等待另一个线程执行操作，但有超时限制
- **BLOCKED（阻塞）**：线程正在等待进入同步块/方法
- **NEW（新建）**：线程已创建但尚未启动
- **TERMINATED（已终止）**：线程已退出

### 线程堆栈信息

线程堆栈显示了线程从开始到当前执行的完整调用链，包括：
- **类名**：执行代码的类
- **方法名**：执行的方法
- **文件名**：源代码文件名
- **行号**：执行的代码行

### 性能指标

- **CPU时间**：线程占用的CPU总时间
- **等待时间**：线程处于等待状态的总时间
- **阻塞时间**：线程被阻塞的总时间
- **优先级**：线程的调度优先级（1-10）
- **守护线程**：是否为守护线程（后台线程）

## 技术架构

### 后端实现

#### 数据模型
- **ProcessInfo**：进程基本信息模型
  - id、serverId、name、pid、command、user
  - type（应用/数据库/缓存/系统/其他）
  - ports、status、startCommand、stopCommand
  - description、autoStart、createdAt、updatedAt

- **ProcessResource**：进程资源使用数据模型
  - id、processId、timestamp
  - cpuUsage、memoryUsage、memoryPercent
  - threadCount、handleCount
  - diskReadRate、diskWriteRate
  - networkReceiveRate、networkSendRate
  - uptime、status

#### 控制器接口
- `GET /api/processes` - 获取进程列表（支持筛选）
- `GET /api/processes/{id}` - 获取进程详情
- `POST /api/processes` - 添加进程
- `PUT /api/processes/{id}` - 更新进程
- `DELETE /api/processes/{id}` - 删除进程
- `POST /api/processes/{id}/start` - 启动进程
- `POST /api/processes/{id}/stop` - 停止进程
- `POST /api/processes/{id}/restart` - 重启进程
- `GET /api/processes/{id}/resources` - 获取资源数据
- `POST /api/processes/{id}/resources/collect` - 采集资源数据
- `GET /api/processes/stats/summary` - 获取统计摘要

### 前端实现

#### 页面结构
- **统计摘要卡片**：显示进程总数、运行中、已停止、异常数量
- **筛选工具栏**：按服务器、状态筛选进程
- **进程卡片网格**：展示所有进程的卡片
  - 进程名称和状态徽章
  - 基本信息展示（PID、类型、端口）
  - 资源使用进度条（CPU、内存）
  - 操作按钮（详情、采集、启停、删除）
- **添加进程弹窗**：表单填写进程信息
- **进程详情弹窗**：完整信息和资源趋势图表

#### 样式设计
- 响应式网格布局
- 渐变色进度条（绿色-黄色-红色）
- 流畅的动画过渡效果
- 深紫色主题配色
- 卡片式UI设计

## 使用指南

### 1. 访问进程管理页面

启动应用后，访问：
```
http://localhost:8080/process-monitor.html
```

或者从服务器管理页面点击"进程管理"链接。

### 2. 监控线程

**查看线程列表：**
1. 在进程列表中找到运行中的进程
2. 点击"线程监控"按钮
3. 系统会显示该进程的所有线程
4. 查看线程状态、优先级、CPU时间等信息

**采集线程数据：**
1. 在线程监控弹窗中点击"采集数据"按钮
2. 系统会生成20条模拟线程数据
3. 可按状态筛选线程（运行中、等待、阻塞等）

**查看线程堆栈：**
1. 在线程列表中，点击某个线程的"查看堆栈"按钮
2. 系统显示该线程的完整调用堆栈
3. 堆栈按照调用顺序从上到下排列
4. 可以直观地看到线程正在执行的代码路径

**分析线程统计：**
- 线程监控页面顶部显示统计信息：
  - 总线程数、活跃线程数、守护线程数
  - 平均CPU时间
  - 各状态的线程分布

### 3. 访问进程管理页面

启动应用后，访问：
```
http://localhost:8080/process-monitor.html
```

或者从服务器管理页面点击"进程管理"链接。

### 2. 添加进程

1. 点击"添加进程"按钮
2. 填写进程信息：
   - 进程名称：如 "Nginx"、"MySQL"
   - 所属服务器：从下拉列表选择
   - 进程类型：选择合适的应用类型
   - 端口：多个端口用逗号分隔，如 "80,443"
   - 启动命令：启动进程的完整命令
   - 停止命令：停止进程的命令，支持 `$PID` 变量
   - 描述：进程的简要说明
   - 自动启动：勾选后进程会在系统启动时自动运行
3. 点击"保存"完成添加

### 3. 监控线程

**查看线程列表：**
1. 在进程列表中找到运行中的进程
2. 点击"线程监控"按钮
3. 系统会显示该进程的所有线程
4. 查看线程状态、优先级、CPU时间等信息

**采集线程数据：**
1. 在线程监控弹窗中点击"采集数据"按钮
2. 系统会生成20条模拟线程数据
3. 可按状态筛选线程（运行中、等待、阻塞等）

**查看线程堆栈：**
1. 在线程列表中，点击某个线程的"查看堆栈"按钮
2. 系统显示该线程的完整调用堆栈
3. 堆栈按照调用顺序从上到下排列
4. 可以直观地看到线程正在执行的代码路径

**分析线程统计：**
- 线程监控页面顶部显示统计信息：
  - 总线程数、活跃线程数、守护线程数
  - 平均CPU时间
  - 各状态的线程分布

### 4. 监控进程

- 页面会自动显示所有进程的当前状态
- 每个进程卡片显示：
  - 进程名称和运行状态
  - PID、类型、端口等基本信息
  - CPU和内存使用率（带彩色进度条）
  - 线程数、句柄数、运行时间等详细数据

### 4. 启动/停止进程

**启动进程：**
1. 找到状态为"已停止"的进程
2. 点击"启动"按钮
3. 确认操作后，进程将执行启动命令
4. 进程状态更新为"运行中"，并生成新的PID

**停止进程：**
1. 找到状态为"运行中"的进程
2. 点击"停止"按钮
3. 确认操作后，进程将执行停止命令
4. 进程状态更新为"已停止"，PID被清空

**重启进程：**
1. 找到状态为"运行中"的进程
2. 点击"重启"按钮
3. 确认操作后，先停止再启动进程
4. 进程状态保持"运行中"，并生成新的PID

### 6. 查看详情和图表

1. 点击"详情"按钮
2. 在弹出的详情窗口中查看：
   - 完整的进程信息
   - 启动和停止命令
   - CPU和内存使用趋势图表（SVG绘制）
   - 历史资源数据

### 7. 采集资源数据

1. 点击"采集数据"按钮
2. 系统会生成30条模拟资源数据（可配置）
3. 数据包括CPU、内存、线程、网络等指标
4. 数据按时间序列存储，可用于图表展示

### 8. 筛选进程

使用页面顶部的筛选器：
- **服务器**：选择特定服务器查看该服务器上的所有进程
- **状态**：筛选运行中、已停止或异常的进程

## 数据存储

### 文件存储位置
- 进程信息：`data/processes.json`
- 进程资源数据：`data/process-resources.json`

### 数据格式
数据以JSON格式存储，便于查看和手动编辑。系统会在每次数据变更时自动保存。

## 扩展功能

### 实际进程操作

当前实现使用模拟数据。在生产环境中，可以通过以下方式实现真实的进程操作：

1. **使用SSH连接到服务器**
2. **执行远程命令**
3. **读取实际进程信息**

示例实现：
```java
public boolean startProcess(Long id) {
    ProcessInfo process = processInfoRepository.findById(id);
    // 使用SSH连接到服务器
    SSHClient client = connectToServer(process.getServerId());
    // 执行启动命令
    String output = client.executeCommand(process.getStartCommand());
    // 解析PID并更新
    process.setPid(parsePid(output));
    processInfoRepository.save(process);
    return true;
}
```

### 实时数据采集

可以通过以下方式实现实时数据采集：
1. 定时任务（如每分钟）
2. 使用系统命令（如 `ps`、`top`）
3. 使用系统API（如 JMX、Procfs）

## 注意事项

1. **优雅停止**：使用 `-15`（SIGTERM）信号而非 `-9`（SIGKILL）
2. **权限管理**：确保服务端有足够权限操作进程
3. **超时处理**：进程启动/停止应设置合理的超时时间
4. **日志记录**：所有操作都应记录日志，便于追踪问题
5. **错误处理**：妥善处理进程操作失败的情况

## 示例数据

系统已预置8个示例进程：
- 2个Web服务器上的Nginx和Java应用
- 1个MySQL数据库服务
- 1个Redis缓存服务
- 1个RabbitMQ消息队列服务
- 1个测试环境服务（已停止）

可以通过删除这些数据或添加新的进程来测试完整功能。

## API端点总结

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/processes | 获取进程列表 |
| GET | /api/processes/{id} | 获取进程详情 |
| POST | /api/processes | 添加进程 |
| PUT | /api/processes/{id} | 更新进程 |
| DELETE | /api/processes/{id} | 删除进程 |
| POST | /api/processes/{id}/start | 启动进程 |
| POST | /api/processes/{id}/stop | 停止进程 |
| POST | /api/processes/{id}/restart | 重启进程 |
| GET | /api/processes/{id}/resources | 获取资源数据 |
| POST | /api/processes/{id}/resources/collect | 采集资源数据 |
| GET | /api/processes/stats/summary | 获取统计摘要 |

## 快速开始

1. 启动应用：`mvn spring-boot:run`
2. 访问：http://localhost:8080/process-monitor.html
3. 查看预置的示例进程
4. 尝试启动/停止进程
5. 点击"采集数据"生成资源数据
6. 点击"线程监控"查看进程的线程信息
7. 点击"查看堆栈"分析线程的调用链
8. 查看进程详情和图表

## 技术栈

- **后端**：Spring Boot 2.3.3、JDK 8、Lombok
- **前端**：HTML5、CSS3、原生JavaScript
- **存储**：JSON文件存储
- **图表**：原生SVG绘制

## 未来改进

- [ ] 支持真实的SSH远程进程操作
- [ ] 实时WebSocket数据推送
- [ ] 实时线程dump导出
- [ ] 线程死锁检测
- [ ] 线程热点分析
- [ ] 进程日志查看
- [ ] 进程依赖关系图
- [ ] 批量操作支持
- [ ] 进程健康检查
- [ ] 自动化告警
- [ ] 更多图表类型
